

<!DOCTYPE html>
<html lang="en" data-default-color-scheme=&#34;auto&#34;>



<head>
  <meta charset="UTF-8">
  <link rel="apple-touch-icon" sizes="76x76" href="/img/favicon.jpg">
  <link rel="icon" type="image/png" href="/img/favicon.jpg">
  <meta name="viewport"
        content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, shrink-to-fit=no">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  
  <meta name="theme-color" content="#2f4154">
  <meta name="description" content="旅游日志，技术笔记，生活杂谈">
  <meta name="author" content="雾杉cedar">
  <meta name="keywords" content="test">
  <title>编写module file - 四方喫茶舘</title>

  <link  rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.5.3/dist/css/bootstrap.min.css" />


  <link  rel="stylesheet" href="https://cdn.jsdelivr.net/npm/github-markdown-css@4.0.0/github-markdown.min.css" />
  <link  rel="stylesheet" href="/lib/hint/hint.min.css" />

  
    
    
      
      <link  rel="stylesheet" href="https://cdn.jsdelivr.net/npm/highlight.js@10.4.0/styles/github-gist.min.css" />
    
  

  
    <link  rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.5.7/dist/jquery.fancybox.min.css" />
  



<!-- 主题依赖的图标库，不要自行修改 -->

<link rel="stylesheet" href="//at.alicdn.com/t/font_1749284_ba1fz6golrf.css">



<link rel="stylesheet" href="//at.alicdn.com/t/font_1736178_kmeydafke9r.css">


<link  rel="stylesheet" href="/css/main.css" />

<!-- 自定义样式保持在最底部 -->


  <script id="fluid-configs">
    var Fluid = window.Fluid || {};
    var CONFIG = {"hostname":"blog.cedard.top","root":"/","version":"1.8.7","typing":{"enable":true,"typeSpeed":50,"cursorChar":"_","loop":false},"anchorjs":{"enable":true,"element":"h1,h2,h3,h4,h5,h6","placement":"right","visible":"hover","icon":""},"progressbar":{"enable":true,"height_px":3,"color":"#29d","options":{"showSpinner":false,"trickleSpeed":100}},"copy_btn":true,"image_zoom":{"enable":true},"toc":{"enable":true,"headingSelector":"h1,h2,h3,h4,h5,h6","collapseDepth":6},"lazyload":{"enable":false,"onlypost":false},"web_analytics":{"enable":false,"baidu":null,"google":null,"gtag":null,"tencent":{"sid":null,"cid":null},"woyaola":null,"cnzz":null,"leancloud":{"app_id":null,"app_key":null,"server_url":null}}};
  </script>
  <script  src="/js/utils.js" ></script>
  <script  src="/js/color-schema.js" ></script>
<!-- hexo injector head_end start -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.12.0/dist/katex.min.css">

<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/hexo-math@4.0.0/dist/style.css">
<!-- hexo injector head_end end --><meta name="generator" content="Hexo 5.4.2"></head>


<body>
  <header style="height: 70vh;">
    <nav id="navbar" class="navbar fixed-top  navbar-expand-lg navbar-dark scrolling-navbar">
  <div class="container">
    <a class="navbar-brand"
       href="/">&nbsp;<strong>四方喫茶舘</strong>&nbsp;</a>

    <button id="navbar-toggler-btn" class="navbar-toggler" type="button" data-toggle="collapse"
            data-target="#navbarSupportedContent"
            aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
      <div class="animated-icon"><span></span><span></span><span></span></div>
    </button>

    <!-- Collapsible content -->
    <div class="collapse navbar-collapse" id="navbarSupportedContent">
      <ul class="navbar-nav ml-auto text-center">
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/">
                <i class="iconfont icon-home-fill"></i>
                Home
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/archives/">
                <i class="iconfont icon-archive-fill"></i>
                Archives
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/categories/">
                <i class="iconfont icon-category-fill"></i>
                Categories
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/tags/">
                <i class="iconfont icon-tags-fill"></i>
                Tags
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/about/">
                <i class="iconfont icon-user-fill"></i>
                About
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/links/">
                <i class="iconfont icon-link-fill"></i>
                Links
              </a>
            </li>
          
        
        
          <li class="nav-item" id="search-btn">
            <a class="nav-link" data-toggle="modal" data-target="#modalSearch">&nbsp;<i
                class="iconfont icon-search"></i>&nbsp;</a>
          </li>
        
        
          <li class="nav-item" id="color-toggle-btn">
            <a class="nav-link" href="javascript:">&nbsp;<i
                class="iconfont icon-dark" id="color-toggle-icon"></i>&nbsp;</a>
          </li>
        
      </ul>
    </div>
  </div>
</nav>

    <div class="banner" id="banner" parallax=true
         style="background: url('/img/defaultbg.jpg') no-repeat center center;
           background-size: cover;">
      <div class="full-bg-img">
        <div class="mask flex-center" style="background-color: rgba(0, 0, 0, 0.3)">
          <div class="page-header text-center fade-in-up">
            <span class="h2" id="subtitle" title="编写module file">
              
            </span>

            
              <div class="mt-3">
  
  
    <span class="post-meta">
      <i class="iconfont icon-date-fill" aria-hidden="true"></i>
      <time datetime="2022-04-03 14:18" pubdate>
        April 3, 2022 pm
      </time>
    </span>
  
</div>

<div class="mt-1">
  

  
    
    <span class="post-meta mr-2">
      <i class="iconfont icon-clock-fill"></i>
      
      
      14
       mins reading time
    </span>
  

  
  
</div>

            
          </div>

          
        </div>
      </div>
    </div>
  </header>

  <main>
    
      

<div class="container-fluid nopadding-x">
  <div class="row nomargin-x">
    <div class="d-none d-lg-block col-lg-2"></div>
    <div class="col-lg-8 nopadding-x-md">
      <div class="container nopadding-x-md" id="board-ctn">
        <div class="py-5" id="board">
          <article class="post-content mx-auto">
            <!-- SEO header -->
            <h1 style="display: none">编写module file</h1>
            
            <div class="markdown-body">
              <p>本文介绍的是lua based lmod环境变量模组。如果你用的是一台小型私人服务器，那么你根本不需要这种玩意。</p>
<p>也就是说，Lmod只有在大型服务器，有非常多用户使用，并且还需要非常多不同版本或者不同种类的基本编译套件时，可以发挥最大用处。如果你只是用一台私人服务器跑东西，那么你要做的只是把所有的binary文件目录都加入环境变量PATH里，再把所有load library加到环境变量LD_LIBRARY_PATH里面。</p>
<p>这两天开始苦逼地当学校超算的运维，于是需要搞定这种玩意。稍微写一下博客。学校超算组的链接：<a target="_blank" rel="noopener" href="https://ntuhpc.org/">https://ntuhpc.org/</a></p>
<h1 id="什么是Lmod"><a href="#什么是Lmod" class="headerlink" title="什么是Lmod"></a>什么是Lmod</h1><p>Lmod is a Lua based module system that easily handles the MODULEPATH Hierarchical problem. Environment Modules provide a convenient way to dynamically change the users’ environment through modulefiles. This includes easily adding or removing directories to the PATH environment variable. Modulefiles for Library packages provide environment variables that specify where the library and header files can be found.</p>
<p>（小学二年级英语）：Lmod是一个基于Lua的模组系统，可以简单解决modulepath的等级分划问题（dependency）。Lmod提供了一种简便的方法来修改用户的运行环境，通过编写modulefiles的方法。这包括了对环境变量PATH的增删。而Modulefile则提供了对于库文件和头文件的说明。</p>
<p>那么，Lmod有多方便呢？举个例子：假如说你把python3.8安装在了自己的家目录，但是忘了加到PATH里面去；那么你在terminal里面敲一个python3，就会有这种提示：</p>
<figure class="highlight vim"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs vim">[root@fedora ~]# <span class="hljs-keyword">python3</span><br>-bash: <span class="hljs-keyword">python3</span>: <span class="hljs-keyword">command</span> not found<br></code></pre></td></tr></table></figure>

<p>你感到不解，于是你尝试echo $PATH，才发现python原来没有被加到自己的环境变量里去。你感到很恼火，于是修改了一下自己的.bashrc，加了一条export。</p>
<p>但是在将来的一天，你把这件事忘了；但是python3.9更新了！于是你在自己的服务器上安装了python3.9，仍然安装在自己的家目录；当你在terminal里敲击python3，冒出来的却是python3.8的interactive session。你这才想起来自己的环境变量里面写的是python3.8，于是你十分恼火，再进到.bashrc里，把3.8改了。</p>
<p>当然，这说的是一件特殊的例子，也许python3.8并不影响你的运行效率；但是如果，你在编译一个大型项目，里面提供了N套编译方案，可以使用N套不同的，互相不兼容的编译套件呢？（比如gcc和icc）</p>
<p>没有Lmod的话，你就只能不停地修改PATH，或者高明一点，写一个脚本帮你解决，每次都要运行，每次有新的模组进来都要修改。于是聪明的程序员们用lua写了Lmod，一劳永逸地彻底解决这个问题。</p>
<p>有了Lmod，你在terminal里面就只需要敲击module av(ailable)，就会有以下的东西蹦出来：</p>
<figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs awk">[root@fedora ~]<span class="hljs-comment"># module av</span><br><br>--------------------------------------------------- <span class="hljs-regexp">/opt/m</span>odulefile ----------------------------------------------------<br>   python3<span class="hljs-regexp">/3.8				python3/</span><span class="hljs-number">3.9</span><br></code></pre></td></tr></table></figure>

<p>那么接下来的事情就轻松很多。如果你想要使用3.8，那么你就可以module load python3&#x2F;3.8；如果你想要换成3.9，那么你就可以module load python3&#x2F;3.9.</p>
<p>如何让module av显示出所有系统中，系统管理员想让你看到的所有module呢？这要通过编写modulefile来解决。</p>
<h2 id="编写modulefile"><a href="#编写modulefile" class="headerlink" title="编写modulefile"></a>编写modulefile</h2><p>modulefile不难写：<a target="_blank" rel="noopener" href="https://lmod.readthedocs.io/en/latest/015_writing_modules.html">https://lmod.readthedocs.io/en/latest/015_writing_modules.html</a></p>
<p>简而言之，modulefile的位置可以放在任何位置，只要它也被包括进module本身的查询list中。举个例子，我们将cuda安装在&#x2F;usr&#x2F;local&#x2F;cuda-11.4中，我们就可以在&#x2F;opt&#x2F;modulefile里mkdir一个新的目录cuda，里面再写一个文件11.4.lua，这表示这是module cuda下属的版本11.4.</p>
<figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs awk">[root@fedora cuda]<span class="hljs-comment"># cat 11.4.lua</span><br>help([[<br>https:<span class="hljs-regexp">//</span>docs.nvidia.com<span class="hljs-regexp">/cuda/</span>cuda-toolkit-release-notes/index.html<br>]])<br>prepend_path( <span class="hljs-string">&quot;PATH&quot;</span>,           <span class="hljs-string">&quot;/usr/local/cuda-11.4/bin&quot;</span>)<br>prepend_path( <span class="hljs-string">&quot;LD_LIBRARY_PATH&quot;</span>,<span class="hljs-string">&quot;/usr/local/cuda-11.4/lib64&quot;</span>)<br>[root@fedora cuda]<span class="hljs-comment">#</span><br></code></pre></td></tr></table></figure>

<p>help语句在module help的时候比较有用，他会告诉你，这个module的用处是什么。这里是直接的来自nvidia的url。</p>
<p>prepend_path就很好理解了。第一个slot放的是变量名，第二个则是需要prepend的path。也就是说，在执行module load cuda的时候，会执行这两行命令。</p>
<p>除去prepend_path之外，还有一个API可能会比较有用，setenv。当然也很好理解，这种可能在gcc的modulepath中比较有用。</p>
<p>当然，在编写完modulefile之后，不要忘了把modulepath添加进module自己，否则module av不会显示这个目录。添加的方法是，module use $(需要添加的目录)</p>
<p>以上。</p>

            </div>
            <hr>
            <div>
              <div class="post-metas mb-3">
                
                  <div class="post-meta mr-3">
                    <i class="iconfont icon-category"></i>
                    
                      <a class="hover-with-bg" href="/categories/tech/">tech</a>
                    
                  </div>
                
                
              </div>
              
              
            </div>

            
              <!-- Comments -->
              <article class="comments" id="comments">
                
                
  <div class="disqus" style="width:100%">
    <div id="disqus_thread"></div>
    <script type="text/javascript">
      var disqus_config = function() {
        this.page.url = 'http://blog.cedard.top/tech/2022.04.03.14/';
        this.page.identifier = '/tech/2022.04.03.14/';
      };
      Fluid.utils.waitElementVisible('disqus_thread', function () {
        var d = document, s = d.createElement('script');
        s.src = '//' + 'fluid' + '.disqus.com/embed.js';
        s.setAttribute('data-timestamp', new Date());
        (d.head || d.body).appendChild(s);
      });
    </script>
    <noscript>Please enable JavaScript to view the
      <a target="_blank" href="https://disqus.com/?ref_noscript" rel="nofollow noopener noopener">comments powered by Disqus.</a>
    </noscript>
  </div>


              </article>
            
          </article>
        </div>
      </div>
    </div>
    
      <div class="d-none d-lg-block col-lg-2 toc-container" id="toc-ctn">
        <div id="toc">
  <p class="toc-header"><i class="iconfont icon-list"></i>&nbsp;TOC</p>
  <div class="toc-body" id="toc-body"></div>
</div>

      </div>
    
  </div>
</div>

<!-- Custom -->


    

    
      <a id="scroll-top-button" href="#" role="button">
        <i class="iconfont icon-arrowup" aria-hidden="true"></i>
      </a>
    

    
      <div class="modal fade" id="modalSearch" tabindex="-1" role="dialog" aria-labelledby="ModalLabel"
     aria-hidden="true">
  <div class="modal-dialog modal-dialog-scrollable modal-lg" role="document">
    <div class="modal-content">
      <div class="modal-header text-center">
        <h4 class="modal-title w-100 font-weight-bold">Search</h4>
        <button type="button" id="local-search-close" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body mx-3">
        <div class="md-form mb-5">
          <input type="text" id="local-search-input" class="form-control validate">
          <label data-error="x" data-success="v"
                 for="local-search-input">keyword</label>
        </div>
        <div class="list-group" id="local-search-result"></div>
      </div>
    </div>
  </div>
</div>
    

    
  </main>

  <footer class="text-center mt-5 py-3">
  <div class="footer-content">
    
  </div>
  

  

  
</footer>

<!-- SCRIPTS -->

  <script  src="https://cdn.jsdelivr.net/npm/nprogress@0.2.0/nprogress.min.js" ></script>
  <link  rel="stylesheet" href="https://cdn.jsdelivr.net/npm/nprogress@0.2.0/nprogress.min.css" />

  <script>
    NProgress.configure({"showSpinner":false,"trickleSpeed":100})
    NProgress.start()
    window.addEventListener('load', function() {
      NProgress.done();
    })
  </script>


<script  src="https://cdn.jsdelivr.net/npm/jquery@3.5.1/dist/jquery.min.js" ></script>
<script  src="https://cdn.jsdelivr.net/npm/bootstrap@4.5.3/dist/js/bootstrap.min.js" ></script>
<script  src="/js/debouncer.js" ></script>
<script  src="/js/events.js" ></script>
<script  src="/js/plugins.js" ></script>

<!-- Plugins -->




  



  <script  src="https://cdn.jsdelivr.net/npm/tocbot@4.12.0/dist/tocbot.min.js" ></script>



  <script  src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.5.7/dist/jquery.fancybox.min.js" ></script>



  <script  src="https://cdn.jsdelivr.net/npm/anchor-js@4.3.0/anchor.min.js" ></script>



  <script defer src="https://cdn.jsdelivr.net/npm/clipboard@2.0.6/dist/clipboard.min.js" ></script>






  <script  src="https://cdn.jsdelivr.net/npm/typed.js@2.0.11/lib/typed.min.js" ></script>
  <script>
    (function (window, document) {
      var typing = Fluid.plugins.typing;
      var title = document.getElementById('subtitle').title;
      
      typing(title)
      
    })(window, document);
  </script>



  <script  src="/js/local-search.js" ></script>
  <script>
    (function () {
      var path = "/local-search.xml";
      var inputArea = document.querySelector("#local-search-input");
      inputArea.onclick = function () {
        searchFunc(path, 'local-search-input', 'local-search-result');
        this.onclick = null
      }
    })()
  </script>





  

  
    <!-- MathJax -->
    <script>
      MathJax = {
        tex: {
          inlineMath: [['$', '$'], ['\\(', '\\)']]
        },
        options: {
          renderActions: {
            findScript: [10, doc => {
              document.querySelectorAll('script[type^="math/tex"]').forEach(node => {
                const display = !!node.type.match(/; *mode=display/);
                const math = new doc.options.MathItem(node.textContent, doc.inputJax[0], display);
                const text = document.createTextNode('');
                node.parentNode.replaceChild(text, node);
                math.start = { node: text, delim: '', n: 0 };
                math.end = { node: text, delim: '', n: 0 };
                doc.math.push(math);
              });
            }, '', false],
            insertedScript: [200, () => {
              document.querySelectorAll('mjx-container').forEach(node => {
                let target = node.parentNode;
                if (target.nodeName.toLowerCase() === 'li') {
                  target.parentNode.classList.add('has-jax');
                }
              });
            }, '', false]
          }
        }
      };
    </script>

    <script async src="https://cdn.jsdelivr.net/npm/mathjax@3.1.2/es5/tex-svg.js" ></script>

  











<!-- 主题的启动项 保持在最底部 -->
<script  src="/js/boot.js" ></script>



</body>
</html>
